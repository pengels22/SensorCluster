<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sensor Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }
        .tabs {
            display: flex;
            justify-content: center;
            background-color: #1e1e1e;
            padding: 10px;
        }
        .tab-button {
            margin: 0 10px;
            padding: 10px 20px;
            background-color: #2c2c2c;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }
        .tab-button:hover {
            background-color: #3c3c3c;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        #analog-charts, #digital-charts {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        #rs485-console, #log-console {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .center-button {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="tabs">
    <button class="tab-button" onclick="openTab('analog')">Analog</button>
    <button class="tab-button" onclick="openTab('digital')">Digital</button>
    <button class="tab-button" onclick="openTab('rs485')">RS485</button>
    <button class="tab-button" onclick="openTab('logging')">Logging</button>
</div>

<div id="analog" class="tab-content">
    <h2>Analog Sensor Data</h2>
    <div id="analog-charts"></div>
    <div class="center-button">
        <button onclick="toggleAnalogView()">Toggle Split View</button>
    </div>
</div>

<div id="digital" class="tab-content">
    <h2>Digital Input States</h2>
    <div id="digital-charts"></div>
    <div class="center-button">
        <button onclick="toggleDigitalView()">Toggle Split View</button>
    </div>
</div>

<div id="rs485" class="tab-content">
    <h2>RS485 Serial Console</h2>
    <div id="rs485-console"></div>
    <input type="text" id="rs485-input" placeholder="Type RS485 command...">
    <button onclick="sendRS485()">Send</button>
</div>

<div id="logging" class="tab-content">
    <h2>Logging Control</h2>
    <div>
        <button onclick="setLogDuration(3)">3 min</button>
        <button onclick="setLogDuration(10)">10 min</button>
        <button onclick="setLogDuration(30)">30 min</button>
        <button onclick="setLogDuration(60)">60 min</button>
    </div>
    <div>
        <label><input type="checkbox" id="log-analog"> Analog</label>
        <label><input type="checkbox" id="log-digital"> Digital</label>
        <label><input type="checkbox" id="log-rs485"> RS485</label>
    </div>
    <button onclick="startLogging()">Start Logging</button>
    <h3 id="log-timer">Logging not started.</h3>
</div>

<script>
const socket = io();
let analogSplitView = false;
let digitalSplitView = false;
const voltageMap = { 0: 3.3, 1: 5, 2: 12, 3: 24 };
let analogCharts = [];
let digitalCharts = [];

function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName).style.display = 'block';
}

function toggleAnalogView() {
    analogSplitView = !analogSplitView;
    renderAnalogCharts();
}

function toggleDigitalView() {
    digitalSplitView = !digitalSplitView;
    renderDigitalCharts();
}

function sendRS485() {
    const msg = document.getElementById('rs485-input').value;
    socket.emit('rs485_send', { message: msg });
    document.getElementById('rs485-input').value = '';
}

function setLogDuration(mins) {
    socket.emit('set_log_duration', { minutes: mins });
}

function startLogging() {
    const analog = document.getElementById('log-analog').checked;
    const digital = document.getElementById('log-digital').checked;
    const rs485 = document.getElementById('log-rs485').checked;
    socket.emit('start_logging', { analog, digital, rs485 });
}

function getColor(index) {
    const colors = ['red', 'blue', 'green', 'orange'];
    return colors[index % colors.length];
}

function renderAnalogCharts() {
    document.getElementById('analog-charts').innerHTML = '';
    analogCharts = [];
    if (analogSplitView) {
        for (let i = 0; i < 4; i++) {
            const canvas = document.createElement('canvas');
            canvas.id = `analogChart${i}`;
            document.getElementById('analog-charts').appendChild(canvas);
            analogCharts.push(new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: `A${i}`, data: [], borderColor: getColor(i) }] },
                options: { scales: { y: { min: 0, max: 5 } } }
            }));
        }
    } else {
        const canvas = document.createElement('canvas');
        canvas.id = 'analogChart';
        document.getElementById('analog-charts').appendChild(canvas);
        analogCharts.push(new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [0,1,2,3].map(i => ({ label: `A${i}`, data: [], borderColor: getColor(i) }))
            },
            options: { scales: { y: { min: 0, max: 5 } } }
        }));
    }
}

function renderDigitalCharts() {
    document.getElementById('digital-charts').innerHTML = '';
    digitalCharts = [];
    if (digitalSplitView) {
        for (let i = 0; i < 4; i++) {
            const canvas = document.createElement('canvas');
            canvas.id = `digitalChart${i}`;
            document.getElementById('digital-charts').appendChild(canvas);
            digitalCharts.push(new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: `D${i}`, data: [], borderColor: getColor(i) }] },
                options: { scales: { y: { min: 0, max: 1 } }, stepped: true }
            }));
        }
    } else {
        const canvas = document.createElement('canvas');
        canvas.id = 'digitalChart';
        document.getElementById('digital-charts').appendChild(canvas);
        digitalCharts.push(new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [0,1,2,3].map(i => ({ label: `D${i}`, data: [], borderColor: getColor(i) }))
            },
            options: { scales: { y: { min: 0, max: 1 } }, stepped: true }
        }));
    }
}

socket.on('sensor_update', (data) => {
    const now = new Date().toLocaleTimeString();

    if (analogCharts.length) {
        if (analogSplitView) {
            // Split: one chart per analog pin
            analogCharts.forEach((chart, index) => {
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(data.analog[index] || 0);

                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }

                chart.options.scales.y.max = voltageMap[data.voltage_mode] || 5;
                chart.update();
            });
        } else {
            // Combined: one chart, multiple datasets
            const chart = analogCharts[0];

            chart.data.labels.push(now);
            data.analog.forEach((val, index) => {
                chart.data.datasets[index].data.push(val || 0);
            });

            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(d => d.data.shift());
            }

            chart.options.scales.y.max = voltageMap[data.voltage_mode] || 5;
            chart.update();
        }
    }

    if (digitalCharts.length) {
        if (digitalSplitView) {
            digitalCharts.forEach((chart, index) => {
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(data.digital[index] || 0);

                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }

                chart.update();
            });
        } else {
            const chart = digitalCharts[0];

            chart.data.labels.push(now);
            data.digital.forEach((val, index) => {
                chart.data.datasets[index].data.push(val || 0);
            });

            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(d => d.data.shift());
            }

            chart.update();
        }
    }
});


socket.on('rs485_output', (data) => {
    const console = document.getElementById('rs485-console');
    console.textContent += data.line + '\n';
    console.scrollTop = console.scrollHeight;
});

socket.on('log_timer_update', (time) => {
    document.getElementById('log-timer').textContent = 'Time Remaining: ' + time;
});

// Default to show Analog tab
openTab('analog');
renderAnalogCharts();
renderDigitalCharts();
</script>
</body>
</html>
